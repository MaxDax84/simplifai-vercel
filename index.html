<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SimplifAI Clone</title>
  <link rel="stylesheet" href="/theme.css">

  <style>
    /* ===== Wizard layout ===== */
    .wiz{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 4px;
    }

    .credit-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .credit-pill b{ color: var(--text); }

    .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width: 33.333%;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(38,198,255,.85));
      transition: width .35s cubic-bezier(.2,.8,.2,1);
    }

    .steps-wrap{
      position: relative;
      overflow:hidden;
      border-radius: var(--radius);
    }
    .track{
      display:flex;
      width: 300%;
      transform: translateX(0%);
      transition: transform .45s cubic-bezier(.2,.8,.2,1);
      will-change: transform;
    }

    .panel{
      width: 100%;
      flex: 0 0 100%;
      padding: 18px;
      display:flex;
      flex-direction:column;
      min-height: 520px;
    }

    .panel-title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
      margin: 0 0 8px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .panel-sub{
      margin: 0 0 14px;
      color: var(--muted);
      line-height: 1.45;
      font-size: 14px;
    }

    .sym{
      width: 18px;
      display:inline-flex;
      justify-content:center;
      opacity:.92;
    }

    textarea{
      width:100%;
      min-height: 220px;
      resize: vertical;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      color: var(--text);
      font-size: 14px;
      line-height: 1.45;
      outline: none;
    }
    textarea:focus{
      border-color: rgba(124,92,255,.50);
      box-shadow: 0 0 0 4px rgba(124,92,255,.15);
    }

    /* Sticky action bar */
    .wizard-actions{
      margin-top: auto;
      position: sticky;
      bottom: 0;
      padding-top: 12px;
      padding-bottom: 8px;
      background: linear-gradient(
        180deg,
        transparent,
        rgba(11,16,32,.75) 35%,
        rgba(11,16,32,.92)
      );
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(233,237,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .wizard-actions .left,
    .wizard-actions .right{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    @media (max-width: 600px){
      textarea{ min-height: 200px; }
      .wizard-actions{ padding-bottom: 12px; }
    }

    /* ===== Targets grid ===== */
    .targets-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 880px){
      .targets-grid{ grid-template-columns: 1fr; }
    }

    .target-card{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: .15s ease;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      min-height: 86px;
    }
    .target-card:hover{
      background: rgba(255,255,255,.05);
      transform: translateY(-1px);
    }
    .target-card.active{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.14);
    }
    .ticon{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      font-size: 18px;
      flex: 0 0 auto;
    }
    .tname{ font-weight: 900; margin:0; }
    .tdesc{ margin: 4px 0 0; color: var(--muted); font-size: 13px; line-height:1.35; }

    /* ===== Response area ===== */
    .target-chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 10px;
    }
    .target-chip b{ color: var(--text); }

    .response-card{
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      min-height: 260px;
      display:flex;
      flex-direction: column;
      gap: 12px;
    }
    .response-text{
      font-size: 14px;
      line-height: 1.55;
      color: rgba(233,237,255,.92);
      white-space: pre-wrap;
      word-break: break-word;
      flex: 1;
    }
    .response-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-top: 6px;
      border-top: 1px solid rgba(233,237,255,.08);
      flex-wrap: wrap;
    }

    .status{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .spinner{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(233,237,255,.25);
      border-top-color: rgba(233,237,255,.85);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== Premium quota box (dark glass) ===== */
    .quota-premium-card{
      border-radius: 18px;
      border: 1px solid rgba(124,92,255,.35);
      background: rgba(124,92,255,.10);
      padding: 16px;
      animation: qfade .35s cubic-bezier(.2,.8,.2,1);
    }
    @keyframes qfade{ from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }

    .qhead{
      display:flex; align-items:center; gap:10px; margin-bottom: 6px;
      font-weight: 900;
    }
    .qsub{ color: var(--muted); font-size: 13px; line-height: 1.45; }
    .qprogress{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid var(--border);
      overflow:hidden;
      margin: 10px 0 12px;
    }
    .qbar{
      height:100%;
      width:100%;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(38,198,255,.85));
      transition: width 1s linear;
    }
    .qgrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 560px){
      .qgrid{ grid-template-columns: 1fr; }
    }

    .qbtn{
      min-height: 44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      transition:.15s ease;
    }
    .qbtn:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }

    .qbtn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(38,198,255,.85));
      border-color: rgba(124,92,255,.45);
      color: #0b1020;
    }
    .qbtn.primary:disabled{
      opacity: .55;
      cursor:not-allowed;
      transform:none;
    }
    .pulse{ animation: pulse 1s ease 2; }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(124,92,255,.35); }
      70%{ box-shadow: 0 0 0 10px rgba(124,92,255,0); }
      100%{ box-shadow: 0 0 0 0 rgba(124,92,255,0); }
    }

    details.qdetails{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    details.qdetails summary{
      cursor:pointer;
      font-weight: 800;
      color: var(--text);
    }
    .qtech{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: rgba(233,237,255,.9);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>SimplifAI Clone</h1>
          <span>Risposte su misura, con ‚ÄúContinua‚Äù quando serve</span>
        </div>
      </div>

      <nav id="mainNav">
        <a href="/index.html" data-nav="home">Home</a>
        <a href="/come-funziona.html" data-nav="how">Come funziona</a>
        <a href="/prezzi.html" data-nav="pricing">Prezzi</a>
      </nav>
    </header>

    <div class="wiz">
      <div class="topline">
        <div class="pilltag">üßô Wizard</div>
        <div class="credit-pill" id="creditsPill">‚ö° Crediti disponibili: <b id="creditsValue">‚Äî</b></div>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>

      <div class="card steps-wrap">
        <div class="track" id="track">

          <!-- STEP 1 -->
          <div class="panel">
            <div class="panel-title"><span class="sym">‚ú¶</span>Step 1 ‚Äî Scrivi la domanda</div>
            <p class="panel-sub">Inserisci la tua domanda. Poi vai avanti per scegliere il livello di spiegazione.</p>

            <textarea id="query" placeholder="Esempio: Spiegami cos‚Äô√® il DNA e a cosa serve."></textarea>

            <div class="wizard-actions">
              <div class="left">
                <span class="pilltag">üí° Suggerimento: aggiungi ‚Äúcon esempi‚Äù</span>
              </div>
              <div class="right">
                <button class="btn btn-primary" id="toStep2">Avanti ‚Üí</button>
              </div>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="panel">
            <div class="panel-title"><span class="sym">üéØ</span>Step 2 ‚Äî Scegli il target</div>
            <p class="panel-sub">Seleziona un target: appena lo scegli, ti porto automaticamente allo step 3.</p>

            <div class="targets-grid" id="targets"></div>

            <div class="wizard-actions">
              <div class="left">
                <button class="btn" id="back1">‚Üê Indietro</button>
              </div>
              <div class="right">
                <button class="btn btn-primary" id="toStep3" disabled>Vai alla risposta ‚Üí</button>
              </div>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="panel">
            <div class="panel-title"><span class="sym">üí¨</span>Step 3 ‚Äî Risposta</div>
            <p class="panel-sub">Premi ‚ÄúGenera‚Äù per ricevere la risposta in streaming. Se si interrompe, usa ‚ÄúContinua‚Äù.</p>

            <div class="target-chip" id="targetChip" style="display:none;">
              üéØ Target selezionato: <b id="targetChipLabel"></b>
            </div>

            <div class="response-card" id="responseCard">
              <div class="response-text" id="response"></div>

              <div class="response-footer">
                <div class="status">
                  <span id="spinner" class="spinner" style="display:none;"></span>
                  <span id="status">Pronto.</span>
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="copyBtn" disabled><span class="sym">‚ßâ</span>Copia</button>
                  <button class="btn" id="continueBtn" disabled><span class="sym">‚ãØ</span>Continua</button>
                  <button class="btn btn-primary" id="generateBtn"><span class="sym">‚ñ∂</span>Genera</button>
                </div>
              </div>
            </div>

            <div class="wizard-actions">
              <div class="left">
                <button class="btn" id="back2">‚Üê Cambia target</button>
              </div>
              <div class="right">
                <a class="btn" href="/prezzi.html">Vedi Prezzi</a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
  // ===== Navbar active =====
  (function(){
    const path = location.pathname.toLowerCase();
    let key = "home";
    if (path.includes("come-funziona")) key = "how";
    else if (path.includes("prezzi")) key = "pricing";
    else if (path.includes("checkout")) key = "pricing";
    document.querySelectorAll('#mainNav a').forEach(a=>{
      if(a.dataset.nav === key) a.classList.add('nav-active');
    });
  })();

  // ===== Targets & limits =====
  const TARGETS = [
    { label: "Bambino", icon:"üßí", desc:"Semplice, analogie, frasi brevi.", prompt: "Spiega come a un bambino: usa parole semplici, esempi concreti, frasi brevi.", maxTokens: 2500, maxChars: 6000 },
    { label: "Ragazzino", icon:"üßë‚Äçüéì", desc:"Chiaro e un po‚Äô pi√π dettagliato.", prompt: "Spiega come a un ragazzino: semplice ma pi√π dettagliato, esempi e analogie.", maxTokens: 2500, maxChars: 7000 },
    { label: "Universitario", icon:"üéì", desc:"Struttura e concetti corretti.", prompt: "Spiega come a uno studente universitario: struttura chiara, concetti corretti.", maxTokens: 2500, maxChars: 9000 },
    { label: "Adulto", icon:"üßë", desc:"Pratico e diretto, senza banalizzare.", prompt: "Spiega come a un adulto: diretto, pratico, con esempi.", maxTokens: 2500, maxChars: 8000 },
    { label: "Esperto", icon:"üß†", desc:"Dettagli tecnici e caveat.", prompt: "Spiega come a un esperto: dettagli tecnici, assunzioni esplicite, caveat.", maxTokens: 3500, maxChars: 12000 },
    { label: "Scienziato", icon:"üß™", desc:"Rigore, limiti, definizioni.", prompt: "Spiega come a uno scienziato: rigore, definizioni, limiti, struttura.", maxTokens: 3500, maxChars: 14000 }
  ];

  // ===== Wizard state =====
  let step = 1; // 1..3
  let selectedIndex = -1;
  let accumulatedText = "";
  let isGenerating = false;

  // Credits indicator
  const creditsValueEl = document.getElementById("creditsValue");
  function setCredits(val){
    creditsValueEl.textContent = (val === null || val === undefined || val === "") ? "‚Äî" : String(val);
  }
  setCredits("‚Äî");

  // DOM refs
  const track = document.getElementById("track");
  const bar = document.getElementById("bar");

  const q = document.getElementById("query");
  const targetsEl = document.getElementById("targets");

  const toStep2 = document.getElementById("toStep2");
  const toStep3 = document.getElementById("toStep3");
  const back1 = document.getElementById("back1");
  const back2 = document.getElementById("back2");

  const responseCard = document.getElementById("responseCard");
  const responseEl = document.getElementById("response");
  const statusEl = document.getElementById("status");
  const spinnerEl = document.getElementById("spinner");

  const generateBtn = document.getElementById("generateBtn");
  const continueBtn = document.getElementById("continueBtn");
  const copyBtn = document.getElementById("copyBtn");

  const targetChip = document.getElementById("targetChip");
  const targetChipLabel = document.getElementById("targetChipLabel");

  function setStep(n){
    step = n;
    track.style.transform = `translateX(${-(step-1) * 100}%)`;
    bar.style.width = (step * 33.3333) + "%";

    // When arriving at step 3 show selected target pill
    if (step === 3 && selectedIndex >= 0) {
      targetChip.style.display = "inline-flex";
      targetChipLabel.textContent = TARGETS[selectedIndex].label;
    } else if (step !== 3) {
      targetChip.style.display = "none";
    }
  }

  function setStatus(text, loading=false){
    statusEl.textContent = text;
    spinnerEl.style.display = loading ? "inline-block" : "none";
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function clearQuotaBoxes(){
    document.querySelectorAll(".quota-premium-card").forEach(n => n.remove());
  }

  function canContinue(){
    if(selectedIndex < 0) return false;
    const t = TARGETS[selectedIndex];
    const text = accumulatedText.trim();
    if (!text) return false;
    if (/\.\.\.\(continua\)\s*$/i.test(text)) return true;
    if (text.length >= Math.floor(t.maxChars * 0.92)) return true;
    const last = text.slice(-1);
    return ![".", "!", "?", "‚Äù", "\""].includes(last);
  }

  function updateButtons(){
    generateBtn.disabled = isGenerating;
    continueBtn.disabled = isGenerating || !canContinue();
    copyBtn.disabled = isGenerating || !responseEl.textContent.trim();
  }

  // Render targets
  function renderTargets(){
    targetsEl.innerHTML = "";
    TARGETS.forEach((t,i)=>{
      const el = document.createElement("div");
      el.className = "target-card" + (i===selectedIndex ? " active":"");
      el.innerHTML = `
        <div class="ticon">${t.icon}</div>
        <div>
          <p class="tname">${t.label}</p>
          <p class="tdesc">${t.desc}</p>
        </div>
      `;
      el.addEventListener("click", ()=>{
        selectedIndex = i;
        renderTargets();
        toStep3.disabled = false;

        // Auto-advance to step 3
        setStep(3);
        targetChip.style.display = "inline-flex";
        targetChipLabel.textContent = TARGETS[selectedIndex].label;

        // focus on Generate for "app feel"
        setTimeout(() => generateBtn.focus(), 60);
      });
      targetsEl.appendChild(el);
    });
  }
  renderTargets();

  // Step navigation
  toStep2.addEventListener("click", ()=>{
    if(!q.value.trim()){
      q.focus();
      return;
    }
    setStep(2);
  });
  back1.addEventListener("click", ()=> setStep(1));
  toStep3.addEventListener("click", ()=> setStep(3));
  back2.addEventListener("click", ()=> setStep(2));

  // Ctrl/Cmd+Enter => step 2
  q.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
      toStep2.click();
    }
  });

  // ===== Quota box (dark) =====
  function showQuotaBox(message){
    clearQuotaBoxes();

    const retryMatch = message.match(/retry in (\d+)s/i);
    const retrySeconds = retryMatch ? parseInt(retryMatch[1], 10) : 0;

    const box = document.createElement("div");
    box.className = "quota-premium-card";
    box.innerHTML = `
      <div class="qhead">‚ö†Ô∏è Limite gratuito raggiunto</div>
      <div class="qsub">
        Hai esaurito le richieste disponibili per ora.
        ${retrySeconds > 0 ? `Puoi riprovare tra <b id="retry-count">${retrySeconds}</b> secondi.` : ""}
      </div>

      <div class="qprogress"><div class="qbar" id="qbar"></div></div>

      <div class="qgrid">
        <button class="qbtn primary" id="retry-btn" disabled>Riprova</button>
        <a class="qbtn" href="/prezzi.html">Vedi i piani</a>
        <a class="qbtn" href="/checkout.html">Upgrade</a>
      </div>

      <details class="qdetails">
        <summary>Dettagli tecnici</summary>
        <div class="qtech">${escapeHtml(message)}</div>
      </details>
    `;

    responseCard.appendChild(box);

    const retryBtn = box.querySelector("#retry-btn");
    const retryCount = box.querySelector("#retry-count");
    const qbar = box.querySelector("#qbar");

    if (retrySeconds > 0) {
      let remaining = retrySeconds;
      qbar.style.width = "100%";

      const interval = setInterval(() => {
        remaining--;
        if (retryCount) retryCount.textContent = String(Math.max(0, remaining));
        qbar.style.width = (Math.max(0, remaining) / retrySeconds) * 100 + "%";

        if (remaining <= 0) {
          clearInterval(interval);
          retryBtn.disabled = false;
          retryBtn.classList.add("pulse");
        }
      }, 1000);
    } else {
      retryBtn.disabled = false;
      qbar.style.width = "0%";
    }

    retryBtn.addEventListener("click", () => {
      box.remove();
      setStatus("Pronto.", false);
      updateButtons();
    });
  }

  // ===== Credits header parsing =====
  function updateCreditsFromHeaders(headers){
    // Try common names (case-insensitive)
    const keys = [
      "x-credits-remaining",
      "x-ratelimit-remaining",
      "ratelimit-remaining",
      "x-remaining-requests",
      "x-rate-limit-remaining"
    ];

    for (const k of keys) {
      const v = headers.get(k);
      if (v !== null && v !== undefined && String(v).trim() !== "") {
        setCredits(String(v).trim());
        return;
      }
    }
    // keep previous if already set; otherwise show ‚Äî
    if (!creditsValueEl.textContent || creditsValueEl.textContent === "") setCredits("‚Äî");
  }

  // ===== SSE streaming =====
  async function streamGemini(payload, onTextChunk){
    const res = await fetch("/api/gemini", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // Update credits (if backend provides headers)
    updateCreditsFromHeaders(res.headers);

    if (!res.ok) {
      let msg = `Errore HTTP ${res.status}`;
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      try {
        if (ct.includes("application/json")) {
          const j = await res.json();
          msg = j?.error || j?.message || msg;
        } else {
          const t = await res.text();
          if (t && t.trim()) msg = t.trim().slice(0, 600);
        }
      } catch {}
      throw new Error(msg);
    }

    const contentType = (res.headers.get("content-type") || "").toLowerCase();
    if (!contentType.includes("text/event-stream")) {
      const txt = await res.text();
      if (txt) onTextChunk(txt);
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");

    let buffer = "";
    let uiBuffer = "";
    const FLUSH_EVERY = 30;

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });

      const lines = buffer.split("\n");
      buffer = lines.pop() || "";

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed.startsWith("data:")) continue;

        const data = trimmed.slice(5).trim();
        if (!data || data === "[DONE]") continue;

        try {
          const obj = JSON.parse(data);
          const parts = obj?.candidates?.[0]?.content?.parts || [];
          for (const p of parts) {
            if (typeof p?.text === "string") {
              uiBuffer += p.text;
              if (uiBuffer.length >= FLUSH_EVERY) {
                onTextChunk(uiBuffer);
                uiBuffer = "";
              }
            }
          }
        } catch {}
      }
    }

    if (uiBuffer) onTextChunk(uiBuffer);
  }

  function buildPayload(mode){
    const t = TARGETS[selectedIndex];
    return {
      query: q.value.trim(),
      targetPrompt: t.prompt,
      maxTokens: t.maxTokens,
      maxChars: t.maxChars,
      mode,
      previousText: mode === "continue" ? accumulatedText : ""
    };
  }

  async function run(mode){
    clearQuotaBoxes();

    if (!q.value.trim()) { setStep(1); q.focus(); return; }
    if (selectedIndex < 0) { setStep(2); return; }

    // ensure target pill visible on step 3
    targetChip.style.display = "inline-flex";
    targetChipLabel.textContent = TARGETS[selectedIndex].label;

    if (mode === "generate") {
      accumulatedText = "";
      responseEl.textContent = "";
    }

    isGenerating = true;
    updateButtons();
    setStatus(mode === "continue" ? "Sto continuando‚Ä¶" : "Sto generando‚Ä¶", true);

    try{
      await streamGemini(buildPayload(mode), (chunk) => {
        accumulatedText += chunk;
        responseEl.textContent += chunk;
      });

      isGenerating = false;
      setStatus("Fatto.", false);
      updateButtons();

    } catch(err){
      isGenerating = false;
      const msg = err?.message || "Errore.";
      if (/quota|exceeded|retry in|429/i.test(msg)) {
        setStatus("Limite raggiunto.", false);
        showQuotaBox(msg);
      } else {
        setStatus("Errore: " + msg, false);
      }
      updateButtons();
    }
  }

  generateBtn.addEventListener("click", () => run("generate"));
  continueBtn.addEventListener("click", () => run("continue"));

  copyBtn.addEventListener("click", async () => {
    const text = responseEl.textContent || "";
    if (!text.trim()) return;
    try{
      await navigator.clipboard.writeText(text);
      setStatus("Copiato ‚úÖ");
      setTimeout(() => setStatus("Pronto.", false), 900);
    } catch {
      setStatus("Non riesco a copiare (permessi).");
    }
  });

  // initial
  setStep(1);
  setStatus("Pronto.", false);
  updateButtons();
</script>
</body>
</html>
