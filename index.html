<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SimplifAI Clone</title>

<style>
:root{
  --bg:#0b1020;
  --card:#111833;
  --border:rgba(255,255,255,.08);
  --text:#e9edff;
  --muted:rgba(255,255,255,.65);
  --accent:#7c5cff;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
    radial-gradient(700px 520px at 85% 30%, rgba(38,198,255,.18), transparent 55%),
    var(--bg);
  color:var(--text);
}

.wrap{width:min(1100px,92vw);margin:40px auto}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}

.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:40px;height:40px;border-radius:12px;
  background:linear-gradient(135deg,#7c5cff,#26c6ff);
}

nav a{
  color:var(--muted);
  text-decoration:none;
  margin-left:20px;
  font-size:14px;
}
nav a:hover{color:white}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
}
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}

.card{
  background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;
}

h2{
  margin:0 0 8px;
  font-size:18px;
  display:flex;
  align-items:center;
  gap:8px;
}

textarea{
  width:100%;
  min-height:140px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#0e152c;
  color:white;
  padding:12px;
  resize:vertical;
}

.targets{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}

.pill{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  font-size:13px;
}
.pill.active{
  background:rgba(124,92,255,.2);
  color:white;
  border-color:#7c5cff;
}

.actions{
  margin-top:14px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
}

button{
  padding:10px 16px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#1a2142;
  color:white;
  cursor:pointer;
  font-size:14px;
}
button.primary{
  background:linear-gradient(135deg,#7c5cff,#26c6ff);
  border:none;
}
button:disabled{opacity:.5;cursor:not-allowed}

.response-box{
  min-height:220px;
  border-radius:14px;
  background:#0e152c;
  padding:14px;
  border:1px solid var(--border);
  white-space:pre-wrap;
  font-size:14px;
  line-height:1.5;
}

.status{
  font-size:12px;
  color:var(--muted);
  margin-top:10px;
}
</style>
</head>

<body>

<div class="wrap">

<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <strong>SimplifAI Clone</strong><br>
      <small style="color:var(--muted)">Risposte su misura, con ‚ÄúContinua‚Äù quando serve</small>
    </div>
  </div>

  <nav>
    <a href="/come-funziona.html">Come funziona</a>
    <a href="/prezzi.html">Prezzi</a>
  </nav>
</header>

<div class="grid">

<!-- INPUT -->
<div class="card">
  <h2>‚ú¶ Scrivi una domanda</h2>

  <textarea id="query" placeholder="Es: Spiegami cos'√® l'entropia"></textarea>

  <div class="targets" id="targets"></div>

  <div class="actions">
    <button id="copyBtn" disabled>‚ßâ Copia</button>
    <button class="primary" id="generateBtn">‚ñ∂ Genera</button>
  </div>
</div>

<!-- OUTPUT -->
<div class="card">
  <h2>üí¨ Risposta</h2>

  <div class="response-box" id="response"></div>

  <div class="actions">
    <button id="continueBtn" disabled>‚ãØ Continua</button>
  </div>

  <div class="status" id="status">Pronto.</div>
</div>

</div>
</div>

<script>
const TARGETS=[
{label:"Bambino",prompt:"Spiega come a un bambino."},
{label:"Ragazzino",prompt:"Spiega come a un ragazzino."},
{label:"Universitario",prompt:"Spiega come a uno studente universitario."},
{label:"Adulto",prompt:"Spiega come a un adulto."},
{label:"Esperto",prompt:"Spiega come a un esperto."},
{label:"Scienziato",prompt:"Spiega come a uno scienziato."}
];

let selected=0;
let accumulated="";

const targetsEl=document.getElementById("targets");
const responseEl=document.getElementById("response");
const statusEl=document.getElementById("status");

function renderTargets(){
targetsEl.innerHTML="";
TARGETS.forEach((t,i)=>{
const b=document.createElement("button");
b.className="pill"+(i===selected?" active":"");
b.textContent=t.label;
b.onclick=()=>{selected=i;renderTargets()};
targetsEl.appendChild(b);
});
}
renderTargets();

async function generate(mode="generate"){
  const query=document.getElementById("query").value.trim();
  if(!query) return;

  // UI
  statusEl.textContent = mode==="continue" ? "Continuo..." : "Generazione in corso...";
  document.getElementById("generateBtn").disabled = true;
  document.getElementById("continueBtn").disabled = true;

  if(mode==="generate"){
    responseEl.textContent = "";
    accumulated = "";
  }

  try{
    const res=await fetch("/api/gemini",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        query,
        targetPrompt: TARGETS[selected].prompt,
        // se il tuo backend usa maxTokens/maxChars, puoi rimetterli qui
        mode,
        previousText: mode==="continue" ? accumulated : ""
      })
    });

    if(!res.ok){
      const txt=await res.text();
      throw new Error(txt || ("Errore HTTP " + res.status));
    }

    const ct=(res.headers.get("content-type")||"").toLowerCase();

    // Se NON √® SSE, fallback: testo diretto
    if(!ct.includes("text/event-stream")){
      const txt = await res.text();
      accumulated += txt;
      responseEl.textContent += txt;
      statusEl.textContent="Fatto.";
      document.getElementById("generateBtn").disabled = false;
      document.getElementById("continueBtn").disabled = false;
      document.getElementById("copyBtn").disabled = !responseEl.textContent.trim();
      return;
    }

    const reader=res.body.getReader();
    const decoder=new TextDecoder("utf-8");

    let buffer = "";
    let uiBuffer = "";
    const FLUSH = 30;

    while(true){
      const {value,done}=await reader.read();
      if(done) break;

      buffer += decoder.decode(value, {stream:true});

      const lines = buffer.split("\n");
      buffer = lines.pop() || "";

      for(const line of lines){
        const t = line.trim();
        if(!t.startsWith("data:")) continue;

        const data = t.slice(5).trim();
        if(!data || data === "[DONE]") continue;

        try{
          const obj = JSON.parse(data);
          const parts = obj?.candidates?.[0]?.content?.parts || [];
          for(const p of parts){
            if(typeof p?.text === "string"){
              uiBuffer += p.text;
              if(uiBuffer.length >= FLUSH){
                accumulated += uiBuffer;
                responseEl.textContent += uiBuffer;
                uiBuffer = "";
              }
            }
          }
        } catch(e){
          // ignora JSON parziale o non valido
        }
      }
    }

    if(uiBuffer){
      accumulated += uiBuffer;
      responseEl.textContent += uiBuffer;
    }

    statusEl.textContent="Fatto.";
    document.getElementById("generateBtn").disabled = false;
    document.getElementById("continueBtn").disabled = false;
    document.getElementById("copyBtn").disabled = !responseEl.textContent.trim();

  }catch(e){
    statusEl.textContent="Errore: "+ (e?.message || e);
    document.getElementById("generateBtn").disabled = false;
    document.getElementById("continueBtn").disabled = true;
  }
}

</script>

</body>
</html>

