<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simplif-AI ‚Äì App</title>
  <link rel="stylesheet" href="/theme.css">

  <!-- Marked + DOMPurify (render markdown sicuro) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

  <style>
    .section{ margin-top:22px; }
    .badge{ font-weight:900; font-size:12px; color:var(--muted); margin-bottom:8px; }
    .title{ font-weight:900; font-size:20px; margin:0 0 18px; }
    .subt{ color:var(--muted); font-size:14px; margin:0 0 14px; line-height:1.45; }

    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
      font: inherit;
      line-height: 1.45;
    }
    textarea:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 4px rgba(124,92,255,.15);
    }

    .actions{
      display:flex; justify-content:space-between;
      margin-top:14px; flex-wrap:wrap; gap:10px; align-items:center;
    }

    .actions-split{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
    }

    .actions-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .actions-right{
      display:flex;
      justify-content:flex-end;
    }

    @media(max-width:520px){
      .actions-split{ flex-direction:column; align-items:stretch; }
      .actions-right .btn{ width:100%; }
    }

    .hint{ color: var(--muted); font-size: 12px; display:flex; gap:8px; align-items:center; }

    .gridTargets{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    @media(max-width: 680px){
      .gridTargets{ grid-template-columns: 1fr; }
    }

    .tbtn{
      text-align:left;
      border-radius: 16px;
      padding: 14px 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      cursor:pointer;
      display:flex;
      gap: 12px;
      align-items:center;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      color: var(--text);
      user-select:none;
    }
    .tbtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .tbtn:active{ transform: translateY(0); }
    .tbtn.selected{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.10);
      box-shadow: 0 0 0 4px rgba(124,92,255,.15);
    }
    .ticon{
      width: 44px; height: 44px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      font-size: 22px;
      flex: 0 0 auto;
    }
    .tmeta{ display:flex; flex-direction:column; gap:3px; }
    .tlabel{ font-weight: 900; letter-spacing: -.2px; }
    .tdesc{ color: var(--muted); font-size: 13px; line-height: 1.35; }

    .lenRow{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-top: 8px;
    }
    @media(max-width: 980px){
      .lenRow{ grid-template-columns: 1fr; }
    }

    .lbtn{
      text-align:left;
      border-radius: 16px;
      padding: 14px 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      color: var(--text);
      user-select:none;
      min-height: 82px;
    }
    .lbtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .lbtn.selected{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.10);
      box-shadow: 0 0 0 4px rgba(124,92,255,.15);
    }
    .ltitle{ font-weight: 950; }
    .ldesc{ color: var(--muted); font-size: 13px; margin-top: 6px; line-height: 1.35; }
    .ltag{
      color: rgba(233,237,255,.9);
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
      margin-top: 2px;
    }

    .answerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .chips{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .chip b{ color: rgba(233,237,255,.92); font-weight: 900; }

    .answerBox{
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      min-height: 220px;
      line-height: 1.55;
      color: rgba(233,237,255,.92);
      position:relative;
      overflow:hidden;
    }

    .answerActions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .copyBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
    }

    .status{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }

    .quotaBox{
      margin-top: 12px;
      border: 1px solid rgba(255,90,90,.35);
      background: rgba(255,90,90,.08);
      padding: 12px 12px;
      border-radius: 14px;
      color: rgba(255,220,220,.92);
      font-size: 13px;
      line-height: 1.45;
      display:none;
    }

    .pillCredits{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .pillCredits b{ color: rgba(233,237,255,.92); font-weight:900; }

    /* piccolo separatore */
    .divider{ height: 1px; background: rgba(255,255,255,.06); margin: 12px 0; }

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Simplif-AI</h1>
          <span>Concetti complessi spiegati in modo semplice. Scegli tu quanto.</span>
        </div>
      </div>

      <nav id="mainNav">
        <a href="/index.html" data-nav="home">Home</a>
        <a href="/app.html" data-nav="app">App</a>
        <a href="/come-funziona.html" data-nav="how">Come funziona</a>
        <a href="/prezzi.html" data-nav="pricing">Prezzi</a>
      </nav>

      <!-- credits pill -->
      <div class="pillCredits" id="creditsPill" style="margin-left:auto;">
        ‚ö° Crediti: <b id="creditsText">‚Äî</b>
      </div>

      <!-- mobile hamburger -->
      <button class="nav-toggle" id="navToggle" type="button" aria-label="Apri menu">
        <span></span><span></span><span></span>
      </button>
    </header>

    <!-- Mobile overlay menu -->
    <div class="mobile-nav" id="mobileNav">
      <a href="/index.html">Home</a>
      <a href="/app.html">App</a>
      <a href="/come-funziona.html">Come funziona</a>
      <a href="/prezzi.html">Prezzi</a>
    </div>

    <!-- 1) DOMANDA -->
    <section class="section" id="sec1">
      <div class="card" id="card1">
        <div class="card-inner">
          <div class="badge">1/4</div>
          <h2 class="title">‚ú¶ Scrivi la domanda</h2>
          <p class="subt">Cosa vuoi sapere?</p>

          <textarea id="query" placeholder="Esempio: 'DNA' oppure 'Cos'√® il DNA e a cosa serve?'"></textarea>

          <div class="actions">
            <span class="hint">üí° Suggerimento: aggiungi ‚Äúcon esempi‚Äù</span>
            <button class="btn btn-primary" id="goTargets" type="button">Scegli target ‚Üì</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 2) TARGET -->
    <section class="section" id="sec2">
      <div class="card" id="card2">
        <div class="card-inner">
          <div class="badge">2/4</div>
          <h2 class="title">üéØ A chi vuoi spiegarlo?</h2>
          <p class="subt">Scegli il livello: pi√π semplice o pi√π approfondito.</p>

          <div class="gridTargets" id="targetsGrid"></div>

          <div class="actions">
            <button class="btn" id="backToQ" type="button">‚Üë Cambia domanda</button>
            <button class="btn btn-primary" id="goLength" type="button">Scegli lunghezza ‚Üì</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) LUNGHEZZA -->
    <section class="section" id="secLen">
      <div class="card" id="cardLen">
        <div class="card-inner">
          <div class="badge">3/4</div>
          <h2 class="title">üìè Quanto lunga?</h2>
          <p class="subt">La generazione parte quando scegli la lunghezza.</p>

          <div class="lenRow" id="lenRow"></div>

          <div class="actions">
            <button class="btn" id="backToTargets" type="button">‚Üë Cambia target</button>
            <button class="btn btn-primary" id="goAnswer" type="button">Vai alla risposta ‚Üì</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 4) RISPOSTA -->
    <section class="section" id="sec3">
      <div class="card" id="card3">
        <div class="card-inner">
          <div class="badge">4/4</div>
          <h2 class="title">üí¨ Risposta</h2>

          <div class="answerTop">
            <div class="chips" id="chips" style="display:none;">
              <span class="chip">üéØ Target: <b id="chipTarget">‚Äî</b></span>
              <span class="chip">üìÑ Lunghezza: <b id="chipLen">‚Äî</b></span>
            </div>

            <div class="answerActions">
              <button class="btn copyBtn" id="copyBtn" type="button" disabled>‚ßâ Copia</button>
            </div>
          </div>

          <div class="answerBox" id="answerBox">
            <div id="answerMount">Pronto.</div>
            <div class="status" id="statusMount"></div>
          </div>

          <div id="quotaMount" class="quotaBox"></div>

          <div class="actions actions-split">
            <div class="actions-left">
              <button class="btn" id="backToLen" type="button">‚Üë Cambia lunghezza</button>
              <button class="btn" id="backToTargetFromAnswer" type="button">‚Üë Cambia target</button>
            </div>
            <div class="actions-right">
              <a class="btn" href="/prezzi.html">Ottieni Simplif-AI PRO</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div style="height:26px;"></div>
  </div>

  <script>
    /* -------------------------
       Mobile nav toggle
    ------------------------- */
    (function(){
      const toggle = document.getElementById("navToggle");
      const mobileNav = document.getElementById("mobileNav");
      if(!toggle || !mobileNav) return;

      toggle.addEventListener("click", () => {
        document.body.classList.toggle("nav-open");
      });
      mobileNav.querySelectorAll("a").forEach(a => {
        a.addEventListener("click", () => document.body.classList.remove("nav-open"));
      });
    })();

    /* -------------------------
       Navbar active
    ------------------------- */
    (function(){
      const path = location.pathname.toLowerCase();
      let key = "home";
      if (path.includes("/app")) key = "app";
      else if (path.includes("come-funziona")) key = "how";
      else if (path.includes("prezzi")) key = "pricing";
      else if (path.includes("checkout")) key = "pricing";
      document.querySelectorAll('#mainNav a').forEach(a=>{
        if(a.dataset.nav === key) a.classList.add('nav-active');
      });
    })();

    /* -------------------------
       Utils scroll
    ------------------------- */
    function scrollTo(section, card){
      const y = section.getBoundingClientRect().top + window.scrollY - 18;
      window.scrollTo({ top: y, behavior: "smooth" });
      if(card){
        card.style.boxShadow = "0 0 0 4px rgba(124,92,255,.15)";
        setTimeout(()=> card.style.boxShadow = "", 800);
      }
    }

    /* -------------------------
       DOM refs
    ------------------------- */
    const q = document.getElementById("query");

    const goTargets = document.getElementById("goTargets");
    const backToQ = document.getElementById("backToQ");
    const goLength = document.getElementById("goLength");
    const backToTargets = document.getElementById("backToTargets");
    const goAnswer = document.getElementById("goAnswer");
    const backToLen = document.getElementById("backToLen");
    const backToTargetFromAnswer = document.getElementById("backToTargetFromAnswer");

    const sec1 = document.getElementById("sec1");
    const sec2 = document.getElementById("sec2");
    const secLen = document.getElementById("secLen");
    const sec3 = document.getElementById("sec3");

    const card1 = document.getElementById("card1");
    const card2 = document.getElementById("card2");
    const cardLen = document.getElementById("cardLen");
    const card3 = document.getElementById("card3");

    const targetsGrid = document.getElementById("targetsGrid");
    const lenRow = document.getElementById("lenRow");

    const answerMount = document.getElementById("answerMount");
    const statusMount = document.getElementById("statusMount");
    const quotaMount = document.getElementById("quotaMount");

    const chips = document.getElementById("chips");
    const chipTarget = document.getElementById("chipTarget");
    const chipLen = document.getElementById("chipLen");

    const copyBtn = document.getElementById("copyBtn");

    const creditsPill = document.getElementById("creditsPill");
    const creditsText = document.getElementById("creditsText");

    /* -------------------------
       Models
    ------------------------- */
    const TARGETS = [
      { label:"Beb√®", icon:"üë∂", desc:"Pochissime parole, super semplice.", prompt:"Spiega come a un beb√® (molto semplice).", maxTokens: 700, maxChars: 900 },
      { label:"Bambino", icon:"üßí", desc:"Semplice, con esempi facili.", prompt:"Spiega come a un bambino (semplice, con esempi).", maxTokens: 1200, maxChars: 1600 },
      { label:"Ragazzo", icon:"üßë‚Äçüéì", desc:"Chiaro ma pi√π completo.", prompt:"Spiega come a un ragazzo (chiaro, un po‚Äô pi√π completo).", maxTokens: 1600, maxChars: 2200 },
      { label:"Universitario", icon:"üéì", desc:"Strutturato e preciso.", prompt:"Spiega come a un universitario (strutturato, preciso).", maxTokens: 2200, maxChars: 3000 },
      { label:"Adulto", icon:"üßë", desc:"Equilibrato e pratico.", prompt:"Spiega come a un adulto (equilibrato, pratico).", maxTokens: 2500, maxChars: 3400 },
      { label:"Esperto", icon:"üß†", desc:"Dettagliato e tecnico.", prompt:"Spiega come a un esperto (dettagliato, tecnico).", maxTokens: 3500, maxChars: 4800 },
      { label:"Scienziato", icon:"üß™", desc:"Massima profondit√†.", prompt:"Spiega come a uno scienziato (molto approfondito).", maxTokens: 3500, maxChars: 5200 }
    ];

    const LENGTHS = [
      { key:"short", label:"Breve", desc:"Risposta rapida, essenziale.", tag:"~1 min", factor: 0.60 },
      { key:"medium", label:"Medio", desc:"Equilibrata, con esempi.", tag:"~2‚Äì3 min", factor: 0.85 },
      { key:"long", label:"Lungo", desc:"Completa, ben strutturata.", tag:"~4‚Äì6 min", factor: 1.00 }
    ];

    /* -------------------------
       State
    ------------------------- */
    let selectedTargetIndex = -1;
    let selectedLenKey = "";
    let accumulatedText = "";
    let isGenerating = false;
    let renderRAF = 0;

    const AUTO_CONTINUE_MAX_HOPS = 6;
    let autoHopCount = 0;

    /* -------------------------
       Render targets & lengths
    ------------------------- */
    function renderTargets(){
      targetsGrid.innerHTML = "";
      TARGETS.forEach((t, idx) => {
        const btn = document.createElement("button");
        btn.className = "tbtn" + (idx === selectedTargetIndex ? " selected" : "");
        btn.type = "button";
        btn.innerHTML = `
          <div class="ticon">${t.icon}</div>
          <div class="tmeta">
            <div class="tlabel">${t.label}</div>
            <div class="tdesc">${t.desc}</div>
          </div>
        `;
        btn.addEventListener("click", () => {
          selectedTargetIndex = idx;
          renderTargets();
          // se gi√† scelta lunghezza, rigenera
          if (selectedLenKey) restartFromConfigChange();
          // auto scroll verso lunghezza se domanda presente
          scrollTo(secLen, cardLen);
        });
        targetsGrid.appendChild(btn);
      });
    }

    function renderLengths(){
      lenRow.innerHTML = "";
      LENGTHS.forEach((l) => {
        const btn = document.createElement("button");
        btn.className = "lbtn" + (l.key === selectedLenKey ? " selected" : "");
        btn.type = "button";
        btn.innerHTML = `
          <div>
            <div class="ltitle">${l.label}</div>
            <div class="ldesc">${l.desc}</div>
          </div>
          <div class="ltag">${l.tag}</div>
        `;
        btn.addEventListener("click", () => {
          selectedLenKey = l.key;
          renderLengths();
          // parte la generazione automaticamente
          scrollTo(sec3, card3);
          restartFromConfigChange();
        });
        lenRow.appendChild(btn);
      });
    }

    renderTargets();
    renderLengths();

    /* -------------------------
       Credits UI
    ------------------------- */
    function updateCreditsFromHeaders(headers){
      const remain = headers.get("x-credits-remaining");
      const limit = headers.get("x-credits-limit");
      if(!remain || !limit) return;
      creditsText.textContent = `${remain}/${limit}`;
    }

    /* -------------------------
       Quota box
    ------------------------- */
    function clearQuotaBox(){
      quotaMount.style.display = "none";
      quotaMount.textContent = "";
    }
    function showQuotaBoxIfNeeded(msg){
      const m = (msg || "").toLowerCase();
      if(m.includes("quota") || m.includes("credit") || m.includes("429") || m.includes("exceed")){
        quotaMount.style.display = "block";
        quotaMount.textContent = msg;
      }
    }

    /* -------------------------
       Markdown render
    ------------------------- */
    function scheduleRender(force=false){
      if(renderRAF && !force) return;
      cancelAnimationFrame(renderRAF);
      renderRAF = requestAnimationFrame(() => {
        renderRAF = 0;
        const md = accumulatedText || "";
        const html = DOMPurify.sanitize(marked.parse(md));
        answerMount.innerHTML = html;
        copyBtn.disabled = !(md && md.trim());
      });
    }

    function setStatus(text, spinning){
      statusMount.textContent = text || "";
      if(spinning){
        statusMount.textContent = text;
      }
    }

    /* -------------------------
       Helpers: length object
    ------------------------- */
    function getLenObj(){
      return LENGTHS.find(l => l.key === selectedLenKey) || null;
    }

    function getMaxTokens(){
      const t = TARGETS[selectedTargetIndex] || null;
      const l = getLenObj();
      if(!t || !l) return 1200;
      return Math.round(t.maxTokens * l.factor);
    }
    function getMaxChars(){
      const t = TARGETS[selectedTargetIndex] || null;
      const l = getLenObj();
      if(!t || !l) return 2000;
      return Math.round(t.maxChars * l.factor);
    }

    /* -------------------------
       Continue markers
    ------------------------- */
    function endsWithContinueMarker(s){
      return /\.\.\.\s*\(continua\)\s*$/i.test((s||"").trim());
    }
    function stripContinueMarker(s){
      return (s || "").replace(/\.\.\.\s*\(continua\)\s*$/i, "").trimEnd();
    }
    function nearLimitHeuristic(s){
      const max = getMaxChars();
      const n = (s || "").length;
      if(!max) return false;
      return n >= Math.floor(max * 0.92);
    }

    /* -------------------------
       Build payload
    ------------------------- */
    function buildPayload(mode){
      const t = TARGETS[selectedTargetIndex];
      const maxTokens = getMaxTokens();

      const qText = q.value.trim();
      const base = `Se non hai spazio sufficiente, termina con "...(continua)". Non troncarmi mai a met√† frase: se serve, usa il marker.`;

      let userPrompt = "";
      if(mode === "continue"){
        userPrompt =
`Continua la risposta senza ripetere. Riparti dall'ultima frase e completala se era rimasta a met√†.
Mantieni lo stesso stile/target e la stessa lunghezza.

TESTO FINORA:
${accumulatedText.trim()}`;
      } else {
        userPrompt =
`${base}

DOMANDA:
${qText}

TARGET:
${t.label}

ISTRUZIONI:
${t.prompt}`;
      }

      return {
        maxOutputTokens: maxTokens,
        prompt: userPrompt
      };
    }

    /* -------------------------
       SSE streaming (robusto)
    ------------------------- */
    async function streamGemini(payload, onTextChunk){
      const res = await fetch("/api/gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      updateCreditsFromHeaders(res.headers);

      if (!res.ok) {
        let msg = `Errore HTTP ${res.status}`;
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        try {
          if (ct.includes("application/json")) {
            const j = await res.json();
            msg = j?.error || j?.message || msg;
          } else {
            const t = await res.text();
            if (t && t.trim()) msg = t.trim().slice(0, 900);
          }
        } catch {}
        throw new Error(msg);
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");

      // finishReason pu√≤ arrivare in qualunque chunk
      let lastFinishReason = "";

      let buffer = "";
      let uiBuffer = "";
      const FLUSH_EVERY = 30;

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });

        // SSE: eventi separati da doppio newline
        const events = buffer.split("\n\n");
        buffer = events.pop() || "";

        for (const evt of events) {
          const lines = evt.split("\n");
          for (const line of lines) {
            if (!line.startsWith("data:")) continue;

            const data = line.slice(5).trim();
            if (!data || data === "[DONE]") continue;

            try {
              const obj = JSON.parse(data);

              const fr = obj?.candidates?.[0]?.finishReason;
              if (typeof fr === "string" && fr) lastFinishReason = fr;

              const parts = obj?.candidates?.[0]?.content?.parts || [];
              for (const p of parts) {
                const t = p?.text || "";
                if (t) {
                  uiBuffer += t;
                  if (uiBuffer.length >= FLUSH_EVERY) {
                    onTextChunk(uiBuffer);
                    uiBuffer = "";
                  }
                }
              }
            } catch {
              // ignore chunk
            }
          }
        }
      }

      if (uiBuffer) onTextChunk(uiBuffer);

      return lastFinishReason;
    }

    /* -------------------------
       Run (generate/continue)
    ------------------------- */
    async function run(mode){
      clearQuotaBox();

      if (!q.value.trim()) {
        isGenerating = false;
        updateButtons();
        setStatus("Scrivi prima una domanda.", false);
        scrollTo(sec1, card1);
        q.focus();
        return;
      }
      if (selectedTargetIndex < 0) {
        isGenerating = false;
        updateButtons();
        setStatus("Scegli un target.", false);
        scrollTo(sec2, card2);
        return;
      }
      if (!selectedLenKey) {
        isGenerating = false;
        updateButtons();
        setStatus("Scegli la lunghezza.", false);
        scrollTo(secLen, cardLen);
        return;
      }

      // UI chips
      chips.style.display = "inline-flex";
      chipTarget.textContent = TARGETS[selectedTargetIndex].label;
      chipLen.textContent = getLenObj()?.label || selectedLenKey;

      // Status
      if (mode === "continue") {
        isGenerating = true;
        updateButtons();
        setStatus(`Sto continuando‚Ä¶ (${autoHopCount + 1})`, true);
      } else {
        isGenerating = true;
        updateButtons();
        setStatus("Sto generando‚Ä¶", true);
      }

      try {
        let rawEndText = "";
        const finishReason = await streamGemini(buildPayload(mode), (chunk) => {
          accumulatedText += chunk;
          rawEndText = accumulatedText;
          scheduleRender();
        });

        const hitTokenLimit =
          typeof finishReason === "string" &&
          (finishReason === "MAX_TOKENS" || finishReason === "MAX_OUTPUT_TOKENS");

        // fallback: se non termina con punteggiatura "finale", √® probabilmente troncata
        const trimmed = (rawEndText || "").trim();
        const endsClean =
          /[.!?‚Ä¶]["'‚Äù‚Äô)]?\s*$/.test(trimmed);

        // decide continuation BEFORE stripping (importante!)
        const needAuto =
          hitTokenLimit ||
          !endsClean ||
          endsWithContinueMarker(rawEndText) ||
          nearLimitHeuristic(rawEndText);

        // strip marker for display + for next continue
        accumulatedText = stripContinueMarker(accumulatedText);
        rawEndText = stripContinueMarker(rawEndText);
        scheduleRender(true);

        // done streaming
        isGenerating = false;
        updateButtons();
        setStatus("Fatto.", false);

        // auto-continue
        if (needAuto) {
          if (autoHopCount < AUTO_CONTINUE_MAX_HOPS) {
            autoHopCount++;
            // continue does NOT consume credits
            await run("continue");
          } else {
            setStatus("Ho raggiunto il limite di continue automatici.", false);
          }
        }

      } catch (e) {
        isGenerating = false;
        updateButtons();
        setStatus(e?.message || "Errore durante la generazione.", false);
        showQuotaBoxIfNeeded(e?.message || "");
      }
    }

    /* -------------------------
       Restart on config change
    ------------------------- */
    function restartFromConfigChange(){
      if(isGenerating) return; // evita doppie chiamate
      autoHopCount = 0;
      accumulatedText = "";
      scheduleRender(true);
      run("generate");
    }

    /* -------------------------
       Buttons state
    ------------------------- */
    function updateButtons(){
      goTargets.disabled = isGenerating;
      goLength.disabled = isGenerating || selectedTargetIndex < 0;
      goAnswer.disabled = isGenerating || !selectedLenKey;
      backToQ.disabled = isGenerating;
      backToTargets.disabled = isGenerating;
      backToLen.disabled = isGenerating;
      if(backToTargetFromAnswer) backToTargetFromAnswer.disabled = isGenerating;
      copyBtn.disabled = isGenerating || !(accumulatedText && accumulatedText.trim());
    }

    updateButtons();

    /* -------------------------
       Buttons navigation
    ------------------------- */
    goTargets.addEventListener("click", () => {
      if (!q.value.trim()) { q.focus(); return; }
      scrollTo(sec2, card2);
    });

    backToQ.addEventListener("click", () => scrollTo(sec1, card1));

    goLength.addEventListener("click", () => {
      if (selectedTargetIndex < 0) return;
      scrollTo(secLen, cardLen);
    });

    backToTargets.addEventListener("click", () => scrollTo(sec2, card2));

    goAnswer.addEventListener("click", () => {
      if (!selectedLenKey) return;
      scrollTo(sec3, card3);
    });

    backToLen.addEventListener("click", () => scrollTo(secLen, cardLen));
    backToTargetFromAnswer?.addEventListener("click", () => scrollTo(sec2, card2));

    /* -------------------------
       Copy
    ------------------------- */
    copyBtn.addEventListener("click", async () => {
      const text = (accumulatedText || "").trim();
      if (!text) return;
      try{
        await navigator.clipboard.writeText(text);
        setStatus("Copiato ‚úÖ", false);
        setTimeout(()=> setStatus("", false), 1000);
      } catch {
        setStatus("Impossibile copiare (permessi browser).", false);
      }
    });

    /* -------------------------
       Trigger rigenerazione se cambi domanda dopo aver scelto len
    ------------------------- */
    let qTimer = 0;
    q.addEventListener("input", () => {
      clearTimeout(qTimer);
      qTimer = setTimeout(() => {
        if(selectedLenKey && selectedTargetIndex >= 0){
          restartFromConfigChange();
        }
      }, 450);
    });
  </script>
</body>
</html>
