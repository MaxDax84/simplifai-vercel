<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simplif-AI ‚Äì App</title>
  <link rel="stylesheet" href="/theme.css">

  <!-- Marked + DOMPurify (render markdown sicuro) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

  <style>
    .section{ margin-top:22px; }
    .title{ font-weight:900; font-size:20px; margin:0 0 18px; }
    .subt{ color:var(--muted); font-size:14px; margin:0 0 14px; line-height:1.45; }

    .hero-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin-top:8px;
    }
    .credit-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted); font-size:12px; user-select:none;
    }
    .credit-pill b{ color:var(--text); }

    textarea{
      width:100%;
      min-height:180px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      color:var(--text);
      font-size:14px;
      line-height:1.45;
      outline:none;
      resize:vertical;
    }
    textarea:focus{
      border-color: rgba(124,92,255,.50);
      box-shadow: 0 0 0 4px rgba(124,92,255,.15);
    }

    .actions{
      display:flex; justify-content:space-between;
      margin-top:14px; flex-wrap:wrap; gap:10px; align-items:center;
    }

    .actions-split{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
    }

    .actions-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .actions-right{
      display:flex;
      justify-content:flex-end;
    }

    @media(max-width:520px){
      .actions-split{ flex-direction:column; align-items:stretch; }
      .actions-right .btn{ width:100%; }
    }

    .hint{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--muted); font-size:12px;
    }

    /* Targets */
    .targets-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:900px){ .targets-grid{ grid-template-columns:1fr; } }

    .target-card{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:14px;
      display:flex; gap:12px;
      cursor:pointer;
      transition:.15s ease;
      min-height:84px;
      align-items:flex-start;
    }
    .target-card:hover{ background:rgba(255,255,255,.05); transform:translateY(-1px); }
    .target-card.active{
      border-color:rgba(124,92,255,.55);
      background:rgba(124,92,255,.14);
    }
    .ticon{
      width:38px; height:38px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:12px;
      font-size:18px;
      flex:0 0 auto;
    }
    .tname{ margin:0; font-weight:900; }
    .tdesc{ margin:4px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }

    /* Length */
    .len-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:900px){ .len-grid{ grid-template-columns:1fr; } }

    .len-card{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:14px;
      cursor:pointer;
      transition:.15s ease;
      min-height:72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .len-card:hover{ background:rgba(255,255,255,.05); transform:translateY(-1px); }
    .len-card.active{
      border-color:rgba(124,92,255,.55);
      background:rgba(124,92,255,.14);
    }
    .len-left{ display:flex; flex-direction:column; gap:4px; }
    .len-name{ font-weight:900; }
    .len-desc{ color:var(--muted); font-size:13px; }
    .len-pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    /* Response */
    .chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted); font-size:13px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .chip b{ color:var(--text); }

    .response-shell{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:16px;
      min-height:260px;
      display:flex; flex-direction:column; gap:12px;
    }

    .status{
      font-size:12px; color:var(--muted);
      display:flex; align-items:center; gap:10px;
    }
    .spinner{
      width:14px; height:14px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color:rgba(255,255,255,.9);
      border-radius:50%;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .flash{
      outline:1px solid rgba(124,92,255,.45);
      box-shadow:0 0 0 6px rgba(124,92,255,.12);
      transition:.35s ease;
    }

    /* Markdown styling */
    .md{
      white-space: normal;
      word-break: break-word;
      line-height: 1.7;
      color: rgba(233,237,255,.92);
      font-size:14px;
    }
    .md h1,.md h2,.md h3{ margin: 14px 0 8px; }
    .md h1{ font-size: 20px; }
    .md h2{ font-size: 18px; }
    .md h3{ font-size: 16px; }
    .md p{ margin: 10px 0; }
    .md ul,.md ol{ margin: 10px 0 10px 22px; }
    .md li{ margin: 6px 0; }
    .md code{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.08);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 13px;
    }
    .md pre{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.08);
      padding: 12px;
      border-radius: 14px;
      overflow:auto;
    }
    .md blockquote{
      margin: 10px 0;
      padding: 10px 12px;
      border-left: 3px solid rgba(124,92,255,.55);
      background: rgba(124,92,255,.10);
      border-radius: 12px;
      color: rgba(233,237,255,.88);
    }
    .md hr{
      border:none;
      border-top:1px solid rgba(255,255,255,.10);
      margin: 14px 0;
    }
    .md a{ color: rgba(38,198,255,.95); }

    .quota-card{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(124,92,255,.35);
      background:rgba(124,92,255,.10);
      padding:16px;
    }
    .qhead{ font-weight:900; margin-bottom:6px; display:flex; gap:10px; align-items:center; }
    .qsub{ color:var(--muted); font-size:13px; line-height:1.45; }
    .qgrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media(max-width:520px){ .qgrid{ grid-template-columns:1fr; } }
    .qbtn{
      min-height:44px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      text-decoration:none;
      transition:.15s ease;
    }
    .qbtn:hover{ background:rgba(255,255,255,.06); transform:translateY(-1px); }
    .qbtn.primary{
      background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(38,198,255,.85));
      border-color:rgba(124,92,255,.45);
      color:#0b1020;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Simplif-AI</h1>
          <span>Concetti complessi spiegati in modo semplice. Scegli tu quanto.</span>
        </div>
      </div>

      <nav id="mainNav">
        <a href="/index.html" data-nav="home">Home</a>
        <a href="/app.html" data-nav="app">Prova</a>
        <a href="/come-funziona.html" data-nav="how">Come funziona</a>
        <a href="/prezzi.html" data-nav="pricing">Prezzi</a>
      </nav>

      <!-- mobile hamburger -->
      <button class="nav-toggle" id="navToggle" type="button" aria-label="Apri menu">
        <span></span><span></span><span></span>
      </button>
    </header>

    <!-- Mobile overlay menu -->
    <div class="mobile-nav" id="mobileNav">
      <a href="/index.html">Home</a>
      <a href="/app.html">Prova</a>
      <a href="/come-funziona.html">Come funziona</a>
      <a href="/prezzi.html">Prezzi</a>
    </div>

    <div class="hero-row">
      <div class="pilltag">‚ú® Flow</div>
      <div class="credit-pill">‚ö° Crediti disponibili: <b id="creditsValue">‚Äî</b></div>
    </div>

    <!-- 1) DOMANDA -->
    <section class="section" id="sec1">
      <div class="card" id="card1">
        <div class="card-inner">
          <div class="badge">1) Domanda</div>
          <h2 class="title">‚ú¶ Scrivi la domanda</h2>
          <p class="subt">Inserisci la domanda e poi clicca ‚ÄúScegli target‚Äù.</p>

          <textarea id="query" placeholder="Esempio: Cos'√® il DNA e a cosa serve?"></textarea>

          <div class="actions">
            <span class="hint">üí° Suggerimento: aggiungi ‚Äúcon esempi‚Äù</span>
            <button class="btn btn-primary" id="goTargets" type="button">Scegli target ‚Üì</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 2) TARGET -->
    <section class="section" id="sec2">
      <div class="card" id="card2">
        <div class="card-inner">
          <div class="badge">2) Target</div>
          <h2 class="title">üéØ Seleziona il target</h2>
          <p class="subt">Clicca un target: poi scegli la lunghezza.</p>

          <div class="targets-grid" id="targets"></div>

          <div class="actions">
            <button class="btn" id="backToQ" type="button">‚Üë Torna alla domanda</button>
            <button class="btn btn-primary" id="goLength" type="button" disabled>Vai alla lunghezza ‚Üì</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) LUNGHEZZA -->
    <section class="section" id="secLen">
      <div class="card" id="cardLen">
        <div class="card-inner">
          <div class="badge">3) Lunghezza</div>
          <h2 class="title">üßæ Quanto lunga la vuoi?</h2>
          <p class="subt">Scegli: parte la generazione automaticamente.</p>

          <div class="len-grid" id="lengths"></div>

          <div class="actions">
            <button class="btn" id="backToTargets" type="button">‚Üë Cambia target</button>
            <button class="btn btn-primary" id="goAnswer" type="button" disabled>Vai alla risposta ‚Üì</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 4) RISPOSTA -->
    <section class="section" id="sec3">
      <div class="card card-dark" id="card3">
        <div class="card-inner">
          <div class="badge">4) Risposta</div>
          <h2 class="title">üí¨ Risposta</h2>
          <p class="subt">Streaming + auto-continue: se serve, continuo automaticamente (con limite di sicurezza).</p>

          <div class="chip" id="chips" style="display:none;">
            üéØ Target: <b id="chipTarget"></b>
            <span style="opacity:.5">‚Ä¢</span>
            üßæ Lunghezza: <b id="chipLen"></b>
          </div>

          <div class="response-shell" id="responseShell">
            <div id="response" class="md"></div>

            <div class="actions" style="margin-top:0;">
              <div class="status">
                <span id="spinner" class="spinner" style="display:none"></span>
                <span id="status">Pronto.</span>
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn" id="copyBtn" type="button" disabled>‚ßâ Copia</button>
              </div>
            </div>

            <div id="quotaMount"></div>
          </div>

          <div class="actions actions-split">
            <div class="actions-left">
              <button class="btn" id="backToLen" type="button">‚Üë Cambia lunghezza</button>
              <button class="btn" id="backToTargetFromAnswer" type="button">‚Üë Cambia target</button>
            </div>
            <div class="actions-right">
              <a class="btn" href="/prezzi.html">Ottieni Simplif-AI PRO</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div style="height:26px;"></div>
  </div>

  <script>
    /* -------------------------
       Mobile nav toggle
    ------------------------- */
    (function(){
      const toggle = document.getElementById("navToggle");
      const mobileNav = document.getElementById("mobileNav");
      if(!toggle || !mobileNav) return;

      toggle.addEventListener("click", () => {
        document.body.classList.toggle("nav-open");
      });
      mobileNav.querySelectorAll("a").forEach(a => {
        a.addEventListener("click", () => document.body.classList.remove("nav-open"));
      });
    })();

    /* -------------------------
       Navbar active
    ------------------------- */
    (function(){
      const path = location.pathname.toLowerCase();
      let key = "home";
      if (path.includes("/app")) key = "app";
      else if (path.includes("come-funziona")) key = "how";
      else if (path.includes("prezzi")) key = "pricing";
      else if (path.includes("checkout")) key = "pricing";
      document.querySelectorAll('#mainNav a').forEach(a=>{
        if(a.dataset.nav === key) a.classList.add('nav-active');
      });
    })();

    /* -------------------------
       Targets & Lengths
    ------------------------- */
    const TARGETS = [
      { label:"Beb√®", icon:"üë∂", desc:"Pochissime parole, super semplice.", prompt:"Spiega come a un beb√®: frasi molto brevi, parole semplicissime, niente dettagli tecnici.", baseTokens:1800, baseChars:4500 },
      { label:"Bambino", icon:"üßí", desc:"Semplice, analogie, frasi brevi.", prompt:"Spiega come a un bambino: usa parole semplici, esempi concreti, frasi brevi.", baseTokens:2500, baseChars:6000 },
      { label:"Ragazzo", icon:"üë®", desc:"Chiaro e un po‚Äô pi√π dettagliato.", prompt:"Spiega come a un ragazzo: chiaro, un po‚Äô pi√π dettagliato, esempi e analogie.", baseTokens:2500, baseChars:7000 },
      { label:"Universitario", icon:"üéì", desc:"Struttura e concetti corretti.", prompt:"Spiega come a uno studente universitario: struttura chiara, concetti corretti.", baseTokens:2500, baseChars:9000 },
      { label:"Esperto", icon:"üß†", desc:"Dettagli tecnici e caveat.", prompt:"Spiega come a un esperto: dettagli tecnici, assunzioni esplicite, caveat.", baseTokens:3500, baseChars:12000 },
      { label:"Scienziato", icon:"üß™", desc:"Rigore, limiti, definizioni.", prompt:"Spiega come a uno scienziato: rigore, definizioni, limiti, struttura.", baseTokens:3500, baseChars:14000 }
    ];

    const LENGTHS = [
      { key:"breve", label:"Breve", desc:"Risposta rapida, essenziale.", pill:"~1 min", multiplier:0.45, instruction:"Rispondi in modo BREVE (essenziale), senza divagare." },
      { key:"medio", label:"Medio", desc:"Equilibrata, con esempi.", pill:"~2‚Äì3 min", multiplier:0.75, instruction:"Rispondi in modo MEDIO: chiaro, con qualche esempio, senza diventare troppo lungo." },
      { key:"lungo", label:"Lungo", desc:"Completa, ben strutturata.", pill:"~4‚Äì6 min", multiplier:1.00, instruction:"Rispondi in modo LUNGO: completo, ben strutturato, con esempi dove utile." }
    ];

    /* -------------------------
       Auto-continue
    ------------------------- */
    const AUTO_CONTINUE_MAX_HOPS = 6;
    let autoHopCount = 0;

    /* -------------------------
       State
    ------------------------- */
    let selectedTargetIndex = -1;
    let selectedLenKey = "";
    let accumulatedText = "";    // markdown
    let isGenerating = false;

    /* -------------------------
       DOM
    ------------------------- */
    const q = document.getElementById("query");

    const targetsEl = document.getElementById("targets");
    const lengthsEl = document.getElementById("lengths");

    const goTargets = document.getElementById("goTargets");
    const backToQ = document.getElementById("backToQ");
    const goLength = document.getElementById("goLength");
    const backToTargets = document.getElementById("backToTargets");
    const goAnswer = document.getElementById("goAnswer");
    const backToLen = document.getElementById("backToLen");
    const backToTargetFromAnswer = document.getElementById("backToTargetFromAnswer");

    const sec1 = document.getElementById("sec1");
    const sec2 = document.getElementById("sec2");
    const secLen = document.getElementById("secLen");
    const sec3 = document.getElementById("sec3");

    const card1 = document.getElementById("card1");
    const card2 = document.getElementById("card2");
    const cardLen = document.getElementById("cardLen");
    const card3 = document.getElementById("card3");

    const responseEl = document.getElementById("response");
    const spinner = document.getElementById("spinner");
    const statusEl = document.getElementById("status");
    const copyBtn = document.getElementById("copyBtn");
    const quotaMount = document.getElementById("quotaMount");

    const chips = document.getElementById("chips");
    const chipTarget = document.getElementById("chipTarget");
    const chipLen = document.getElementById("chipLen");

    const creditsValueEl = document.getElementById("creditsValue");
    function setCredits(v){ creditsValueEl.textContent = v ?? "‚Äî"; }

    /* -------------------------
       Helpers
    ------------------------- */
    function flash(card){
      card.classList.add("flash");
      setTimeout(()=>card.classList.remove("flash"), 420);
    }
    function scrollTo(sec, card){
      sec.scrollIntoView({ behavior:"smooth", block:"start" });
      flash(card);
    }

    function setStatus(text, loading=false){
      statusEl.textContent = text;
      spinner.style.display = loading ? "inline-block" : "none";
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function clearQuotaBox(){ quotaMount.innerHTML = ""; }

    function showQuotaBox(message){
      quotaMount.innerHTML = `
        <div class="quota-card">
          <div class="qhead">‚ö†Ô∏è Limite / crediti</div>
          <div class="qsub">${escapeHtml(message || "Limite temporaneo. Riprova oppure fai upgrade.")}</div>
          <div class="qgrid">
            <a class="qbtn" href="/prezzi.html">Vedi i piani</a>
            <a class="qbtn primary" href="/checkout.html">Upgrade</a>
          </div>
        </div>
      `;
    }

    function updateButtons(){
      copyBtn.disabled = isGenerating || !accumulatedText.trim();
      goLength.disabled = selectedTargetIndex < 0;
      goAnswer.disabled = !selectedLenKey;
    }

    /* Markdown render (throttled) */
    let renderTimer = null;
    function renderNow(){
      // marked.parse -> DOMPurify.sanitize
      const html = marked.parse(accumulatedText || "");
      responseEl.innerHTML = DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
    }
    function scheduleRender(){
      if(renderTimer) return;
      renderTimer = setTimeout(() => {
        renderTimer = null;
        renderNow();
      }, 120);
    }

    function stripContinueMarker(txt){
      return txt.replace(/\.\.\.\(continua\)\s*$/i, "").trimEnd();
    }
    function endsWithContinueMarker(txt){
      return /\.\.\.\(continua\)\s*$/i.test((txt||"").trim());
    }

    function getLenObj(){
      return LENGTHS.find(x => x.key === selectedLenKey) || null;
    }

    function calcLimits(){
      const t = TARGETS[selectedTargetIndex];
      const l = getLenObj() || LENGTHS[1];
      const maxTokens = Math.max(600, Math.floor(t.baseTokens * l.multiplier));
      const maxChars  = Math.max(1800, Math.floor(t.baseChars  * l.multiplier));
      return { maxTokens, maxChars };
    }

    function nearLimitHeuristic(text){
      if (selectedTargetIndex < 0 || !selectedLenKey) return false;
      const { maxChars } = calcLimits();
      const trimmed = (text || "").trim();
      if (!trimmed) return false;
      return trimmed.length >= Math.floor(maxChars * 0.92);
    }

    /* -------------------------
       Credits header parsing
    ------------------------- */
    function updateCreditsFromHeaders(headers){
      const rem = headers.get("x-credits-remaining");
      const lim = headers.get("x-credits-limit");
      if (rem && String(rem).trim() !== "") {
        const r = String(rem).trim();
        const l = lim && String(lim).trim() !== "" ? String(lim).trim() : "";
        setCredits(l ? `${r}/${l}` : r);
      }
    }

    /* -------------------------
       SSE streaming (robusto)
    ------------------------- */
    async function streamGemini(payload, onTextChunk){
      const res = await fetch("/api/gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      updateCreditsFromHeaders(res.headers);

      if (!res.ok) {
        let msg = `Errore HTTP ${res.status}`;
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        try {
          if (ct.includes("application/json")) {
            const j = await res.json();
            msg = j?.error || j?.message || msg;
          } else {
            const t = await res.text();
            if (t && t.trim()) msg = t.trim().slice(0, 900);
          }
        } catch {}
        throw new Error(msg);
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");

      // finishReason pu√≤ arrivare in qualunque chunk
      let lastFinishReason = "";

      let buffer = "";
      let uiBuffer = "";
      const FLUSH_EVERY = 30;

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });

        // SSE: eventi separati da doppio newline
        const events = buffer.split("\n\n");
        buffer = events.pop() || "";

        for (const evt of events) {
          const lines = evt.split("\n");
          for (const line of lines) {
            if (!line.startsWith("data:")) continue;

            const data = line.slice(5).trim();
            if (!data || data === "[DONE]") continue;

            try {
              const obj = JSON.parse(data);

              const fr = obj?.candidates?.[0]?.finishReason;
              if (typeof fr === "string" && fr) lastFinishReason = fr;

              const parts = obj?.candidates?.[0]?.content?.parts || [];
              for (const p of parts) {
                const t = p?.text || "";
                if (t) {
                  uiBuffer += t;
                  if (uiBuffer.length >= FLUSH_EVERY) {
                    onTextChunk(uiBuffer);
                    uiBuffer = "";
                  }
                }
              }
            } catch {
              // ignore chunk
            }
          }
        }
      }

      if (uiBuffer) onTextChunk(uiBuffer);

      return lastFinishReason;
    }

      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      if (!contentType.includes("text/event-stream")) {
        const txt = await res.text();
        if (txt) onTextChunk(txt);
        return;
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");

      let buffer = "";
      let uiBuffer = "";
      const FLUSH_EVERY = 30;

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop() || "";

        for (const line of lines) {
          const trimmed = line.trim();
          if (!trimmed.startsWith("data:")) continue;

          const data = trimmed.slice(5).trim();
          if (!data || data === "[DONE]") continue;

          try {
            const obj = JSON.parse(data);
            const parts = obj?.candidates?.[0]?.content?.parts || [];
            for (const p of parts) {
              if (typeof p?.text === "string" && p.text.length) {
                uiBuffer += p.text;
                if (uiBuffer.length >= FLUSH_EVERY) {
                  onTextChunk(uiBuffer);
                  uiBuffer = "";
                }
              }
            }
          } catch {
            // ignore chunk
          }
        }
      }

      if (uiBuffer) onTextChunk(uiBuffer);
    }

    function buildPayload(mode){
      const t = TARGETS[selectedTargetIndex];
      const l = getLenObj();
      const { maxTokens, maxChars } = calcLimits();

      const lengthInstruction = l ? l.instruction : "";
      const targetPrompt = `${t.prompt}\n\n${lengthInstruction}`;

      return {
        query: q.value.trim(),
        targetPrompt,
        maxTokens,
        maxChars,
        mode: mode === "continue" ? "continue" : "start",
        previousText: mode === "continue" ? accumulatedText : ""
      };
    }

    function preflightGenerateUX(){
      clearQuotaBox();
      accumulatedText = "";
      responseEl.innerHTML = "";
      autoHopCount = 0;

      isGenerating = true;
      updateButtons();
      setStatus("Ok! Sto generando‚Ä¶", true);
    }

    async function run(mode){
      clearQuotaBox();

      if (!q.value.trim()) {
        isGenerating = false;
        updateButtons();
        setStatus("Scrivi prima una domanda.", false);
        scrollTo(sec1, card1);
        q.focus();
        return;
      }
      if (selectedTargetIndex < 0) {
        isGenerating = false;
        updateButtons();
        setStatus("Scegli un target.", false);
        scrollTo(sec2, card2);
        return;
      }
      if (!selectedLenKey) {
        isGenerating = false;
        updateButtons();
        setStatus("Scegli la lunghezza.", false);
        scrollTo(secLen, cardLen);
        return;
      }

      // UI chips
      chips.style.display = "inline-flex";
      chipTarget.textContent = TARGETS[selectedTargetIndex].label;
      chipLen.textContent = getLenObj()?.label || selectedLenKey;

      // Status
      if (mode === "continue") {
        isGenerating = true;
        updateButtons();
        setStatus(`Sto continuando‚Ä¶ (${autoHopCount + 1})`, true);
      } else {
        isGenerating = true;
        updateButtons();
        setStatus("Sto generando‚Ä¶", true);
      }

      try {
        let rawEndText = "";
        const finishReason = await streamGemini(buildPayload(mode), (chunk) => {
          accumulatedText += chunk;
          rawEndText = accumulatedText;
          scheduleRender();
        });

        const hitTokenLimit =
          typeof finishReason === "string" &&
          (finishReason === "MAX_TOKENS" || finishReason === "MAX_OUTPUT_TOKENS");

        // fallback: se non termina con punteggiatura "finale", √® probabilmente troncata
        const trimmed = (rawEndText || "").trim();
        const endsClean =
          /[.!?‚Ä¶]["'‚Äù‚Äô)]?\s*$/.test(trimmed);

        // decide continuation BEFORE stripping (importante!)
        const needAuto =
          hitTokenLimit ||
          !endsClean ||
          endsWithContinueMarker(rawEndText) ||
          nearLimitHeuristic(rawEndText);

        // strip marker for display + for next continue
        accumulatedText = stripContinueMarker(accumulatedText);
        rawEndText = stripContinueMarker(rawEndText);
        scheduleRender(true);

        // done streaming
        isGenerating = false;
        updateButtons();
        setStatus("Fatto.", false);

        // auto-continue
        if (needAuto) {
          if (autoHopCount < AUTO_CONTINUE_MAX_HOPS) {
            autoHopCount++;
            // continue does NOT consume credits
            await run("continue");
          } else {
            setStatus("Ho raggiunto il limite di continue automatici.", false);
          }
        }

      } catch (e) {
        isGenerating = false;
        updateButtons();
        setStatus(e?.message || "Errore durante la generazione.", false);
        showQuotaBoxIfNeeded(e?.message || "");
      }
    }

      // UI chips
      chips.style.display = "inline-flex";
      chipTarget.textContent = TARGETS[selectedTargetIndex].label;
      chipLen.textContent = getLenObj()?.label || selectedLenKey;

      // Status
      if (mode === "continue") {
        isGenerating = true;
        updateButtons();
        setStatus(`Sto continuando‚Ä¶ (${autoHopCount + 1})`, true);
      } else {
        isGenerating = true;
        updateButtons();
        setStatus("Sto generando‚Ä¶", true);
      }

      try {
        let rawEndText = "";
        await streamGemini(buildPayload(mode), (chunk) => {
          accumulatedText += chunk;
          rawEndText = accumulatedText;
          scheduleRender();
        });

        // decide continuation BEFORE stripping (importante!)
        const needAuto = endsWithContinueMarker(rawEndText) || nearLimitHeuristic(rawEndText);

        // strip marker for display + for next continue
        accumulatedText = stripContinueMarker(accumulatedText);
        renderNow();

        isGenerating = false;
        updateButtons();
        setStatus("Fatto.", false);

        if (needAuto && autoHopCount < AUTO_CONTINUE_MAX_HOPS) {
          autoHopCount++;
          isGenerating = true;
          updateButtons();
          setStatus(`Sto continuando automaticamente‚Ä¶ (${autoHopCount})`, true);
          await new Promise(r => setTimeout(r, 200));
          return run("continue");
        }

        autoHopCount = 0;

      } catch (err) {
        isGenerating = false;
        updateButtons();

        const msg = err?.message || "Errore.";
        setStatus("Errore.", false);

        if (err?.status === 429 || /quota|exceeded|retry in|credit/i.test(msg)) {
          showQuotaBox(msg);
        } else {
          showQuotaBox(msg);
        }
      }
    }

    /* -------------------------
       Render targets / lengths
    ------------------------- */
    function renderTargets(){
      targetsEl.innerHTML = "";
      TARGETS.forEach((t, i) => {
        const el = document.createElement("div");
        el.className = "target-card" + (i === selectedTargetIndex ? " active" : "");
        el.innerHTML = `
          <div class="ticon">${t.icon}</div>
          <div>
            <p class="tname">${t.label}</p>
            <p class="tdesc">${t.desc}</p>
          </div>
        `;
        el.addEventListener("click", () => {
          selectedTargetIndex = i;
          renderTargets();
          updateButtons();

          // vai alla lunghezza
          scrollTo(secLen, cardLen);

          // se avevo gi√† scelto la lunghezza, rigenera automaticamente
          if (selectedLenKey) {
            scrollTo(sec3, card3);
            preflightGenerateUX();
            setTimeout(() => run("start"), 220);
          }
        });
        targetsEl.appendChild(el);
      });
    }

    function renderLengths(){
      lengthsEl.innerHTML = "";
      LENGTHS.forEach((l) => {
        const el = document.createElement("div");
        el.className = "len-card" + (l.key === selectedLenKey ? " active" : "");
        el.innerHTML = `
          <div class="len-left">
            <div class="len-name">${l.label}</div>
            <div class="len-desc">${l.desc}</div>
          </div>
          <div class="len-pill">${l.pill}</div>
        `;
        el.addEventListener("click", () => {
          selectedLenKey = l.key;
          renderLengths();
          updateButtons();

          // scroll + auto start
          scrollTo(sec3, card3);
          preflightGenerateUX();
          setTimeout(() => run("start"), 240);
        });
        lengthsEl.appendChild(el);
      });
    }

    renderTargets();
    renderLengths();
    updateButtons();

    /* -------------------------
       Buttons navigation
    ------------------------- */
    goTargets.addEventListener("click", () => {
      if (!q.value.trim()) { q.focus(); return; }
      scrollTo(sec2, card2);
    });

    backToQ.addEventListener("click", () => scrollTo(sec1, card1));

    goLength.addEventListener("click", () => {
      if (selectedTargetIndex < 0) return;
      scrollTo(secLen, cardLen);
    });

    backToTargets.addEventListener("click", () => scrollTo(sec2, card2));

    goAnswer.addEventListener("click", () => {
      if (!selectedLenKey) return;
      scrollTo(sec3, card3);
    });

    backToLen.addEventListener("click", () => scrollTo(secLen, cardLen));
    backToTargetFromAnswer?.addEventListener("click", () => scrollTo(sec2, card2));

    /* -------------------------
       Copy
    ------------------------- */
    copyBtn.addEventListener("click", async () => {
      const text = (accumulatedText || "").trim();
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        setStatus("Copiato ‚úÖ", false);
        setTimeout(() => setStatus("Pronto.", false), 900);
      } catch {
        setStatus("Non riesco a copiare (permessi).", false);
      }
    });

    /* Init */
    setStatus("Pronto.", false);
  </script>
</body>
</html>
